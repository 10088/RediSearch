



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="http://redisearch.io/Threading/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.3">
    
    
      
        <title>Multi-Threading in RediSearch - RediSearch Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#multi-threading"_"in"_"redisearch" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://redisearch.io" title="RediSearch Documentation" class="md-header-nav__button md-logo">
          
            <img src="../logo_small.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                RediSearch Documentation
              </span>
              <span class="md-header-nav__topic">
                Multi-Threading in RediSearch
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/RedisLabsModules/RediSearch/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../logo_small.png" width="48" height="48">
      
    </span>
    RediSearch Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/RedisLabsModules/RediSearch/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Quick_Start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Commands/" title="Command Reference" class="md-nav__link">
      Command Reference
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Configuring/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Administration/" title="Administration" class="md-nav__link">
      Administration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Query_Syntax/" title="Query Syntax" class="md-nav__link">
      Query Syntax
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Stopwords/" title="Stop-Words" class="md-nav__link">
      Stop-Words
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Aggregations/" title="Aggregations (NEW!)" class="md-nav__link">
      Aggregations (NEW!)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Escaping/" title="Tokenization and Escaping" class="md-nav__link">
      Tokenization and Escaping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Sorting/" title="Sortable Values" class="md-nav__link">
      Sortable Values
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tags/" title="Tag Fields" class="md-nav__link">
      Tag Fields
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Highlight/" title="Highlighting Results" class="md-nav__link">
      Highlighting Results
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Scoring/" title="Scoring Documents" class="md-nav__link">
      Scoring Documents
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Extensions/" title="Extension API" class="md-nav__link">
      Extension API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Stemming/" title="Stemming Support" class="md-nav__link">
      Stemming Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Synonyms/" title="Synonyms Support" class="md-nav__link">
      Synonyms Support
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../payloads/" title="Document Payloads" class="md-nav__link">
      Document Payloads
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Clients
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Clients
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Clients/" title="Client Libraries" class="md-nav__link">
      Client Libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python_client/" title="Python API" class="md-nav__link">
      Python API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../java_client/" title="Java API" class="md-nav__link">
      Java API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../go_client/" title="Go API" class="md-nav__link">
      Go API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Design Documents
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Design Documents
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../design/gc/" title="Garbage Collection" class="md-nav__link">
      Garbage Collection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9" checked>
    
    <label class="md-nav__link" for="nav-9">
      Articles
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Multi-Threading in RediSearch
      </label>
    
    <a href="./" title="Multi-Threading in RediSearch" class="md-nav__link md-nav__link--active">
      Multi-Threading in RediSearch
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1"_"one"_"thread"_"to"_"rule"_"them"_"all" title="1. One Thread To Rule Them All" class="md-nav__link">
    1. One Thread To Rule Them All
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2"_"redisearch"_"and"_"the"_"single"_"thread"_"issue" title="2. RediSearch and the Single Thread Issue" class="md-nav__link">
    2. RediSearch and the Single Thread Issue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3"_"enter"_"the"_"redis"_"gil" title="3. Enter the Redis GIL" class="md-nav__link">
    3. Enter the Redis GIL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4"_"making"_"search"_"concurrent" title="4. Making Search Concurrent" class="md-nav__link">
    4. Making Search Concurrent
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#figure"_"1"_"serial"_"vs"_"concurrent"_"search" title="Figure 1: Serial vs. Concurrent Search" class="md-nav__link">
    Figure 1: Serial vs. Concurrent Search
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5"_"the"_"effect"_"of"_"concurrency" title="5. The Effect of Concurrency" class="md-nav__link">
    5. The Effect of Concurrency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6"_"some"_"numbers" title="6. Some Numbers!" class="md-nav__link">
    6. Some Numbers!
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the"_"results" title="The Results:" class="md-nav__link">
    The Results:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7"_"parting"_"words" title="7. Parting Words" class="md-nav__link">
    7. Parting Words
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Chinese/" title="Chinese Support" class="md-nav__link">
      Chinese Support
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1"_"one"_"thread"_"to"_"rule"_"them"_"all" title="1. One Thread To Rule Them All" class="md-nav__link">
    1. One Thread To Rule Them All
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2"_"redisearch"_"and"_"the"_"single"_"thread"_"issue" title="2. RediSearch and the Single Thread Issue" class="md-nav__link">
    2. RediSearch and the Single Thread Issue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3"_"enter"_"the"_"redis"_"gil" title="3. Enter the Redis GIL" class="md-nav__link">
    3. Enter the Redis GIL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4"_"making"_"search"_"concurrent" title="4. Making Search Concurrent" class="md-nav__link">
    4. Making Search Concurrent
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#figure"_"1"_"serial"_"vs"_"concurrent"_"search" title="Figure 1: Serial vs. Concurrent Search" class="md-nav__link">
    Figure 1: Serial vs. Concurrent Search
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5"_"the"_"effect"_"of"_"concurrency" title="5. The Effect of Concurrency" class="md-nav__link">
    5. The Effect of Concurrency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6"_"some"_"numbers" title="6. Some Numbers!" class="md-nav__link">
    6. Some Numbers!
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the"_"results" title="The Results:" class="md-nav__link">
    The Results:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7"_"parting"_"words" title="7. Parting Words" class="md-nav__link">
    7. Parting Words
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/RedisLabsModules/RediSearch/edit/master/docs/Threading.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="multi-threading&quot;_&quot;in&quot;_&quot;redisearch">Multi-Threading in RediSearch<a class="headerlink" href="#multi-threading&quot;_&quot;in&quot;_&quot;redisearch" title="Permanent link">&para;</a></h1>
<p><em>By Dvir Volk, July 2017</em></p>
<h2 id="1&quot;_&quot;one&quot;_&quot;thread&quot;_&quot;to&quot;_&quot;rule&quot;_&quot;them&quot;_&quot;all">1. One Thread To Rule Them All<a class="headerlink" href="#1&quot;_&quot;one&quot;_&quot;thread&quot;_&quot;to&quot;_&quot;rule&quot;_&quot;them&quot;_&quot;all" title="Permanent link">&para;</a></h2>
<p>Redis has been, from its inception, single threaded - and will remain so at least in 4.0. I'm not going to get into the reasons of why that is - but up until now it has been a reality that Redis apps, and more recently Redis Modules such as RediSearch - have to deal with. </p>
<p>While keeping things single-threaded makes Redis simple and fast - the down-side is that long running commands block the entire server for the duration of the query's execution. Most Redis commands are fast so that is not a problem, but commands like <a href="https://Redis.io/commands/zunionstore">ZUNIONSTORE</a>, <a href="https://Redis.io/commands/lrange">LRANGE</a>, <a href="https://Redis.io/commands/sinter">SINTER</a> and of course the infamous <a href="https://Redis.io/commands/keys">KEYS</a>, can block Redis for seconds or minutes, depending on the size of data they are handling. </p>
<h2 id="2&quot;_&quot;redisearch&quot;_&quot;and&quot;_&quot;the&quot;_&quot;single&quot;_&quot;thread&quot;_&quot;issue">2. RediSearch and the Single Thread Issue<a class="headerlink" href="#2&quot;_&quot;redisearch&quot;_&quot;and&quot;_&quot;the&quot;_&quot;single&quot;_&quot;thread&quot;_&quot;issue" title="Permanent link">&para;</a></h2>
<p><a href="https://Redisearch.io">RediSearch</a> is a new search engine module written at Redis Labs. It leverages Redis' powerful infrastructure with efficient data structures, to create a fast and feature rich, real-time search engine. </p>
<p>While it is extremely fast and uses highly optimized data structures and algorithms, it was facing the same problem with regards to concurrency: Depending on the size of your data-set and the cardinality of search queries, they can take internally anywhere between a few microseconds, to hundreds of milliseconds to seconds in extreme cases. And when that happens - the entire Redis server that the engine is running on - is blocked. </p>
<p>Think, for example, on the a full-text query intersecting the terms "hello" and "world", each with, let's say, a million entries, and half a million common intersection points. To do that in a millisecond, you would have to scan, intersect and rank each result in one nanosecond, <a href="https://gist.github.com/jboner/2841832">which is impossible with current hardware</a>. The same goes for indexing a 1000 word document. It blocks Redis entirely for that duration.</p>
<p>So taking into account that in the real world, search queries may not behave like your average Redis O(1) command, and block the entire server for long periods of time. Of course, you could and should split your search index into a cluster, and a cluster version of RediSearch will soon be available as part of Redis Labs Enterprise cluster - but even if we distribute the data across cluster nodes, some queries will be slow.</p>
<h2 id="3&quot;_&quot;enter&quot;_&quot;the&quot;_&quot;redis&quot;_&quot;gil">3. Enter the Redis GIL<a class="headerlink" href="#3&quot;_&quot;enter&quot;_&quot;the&quot;_&quot;redis&quot;_&quot;gil" title="Permanent link">&para;</a></h2>
<p>Luckily, Redis BDFL <a href="https://twitter.com/antirez">Salvatore Sanfilippo</a> has added a revolutionary change just near the finish line of Redis 4.0 and the release of the modules API - <strong>Thread Safe Contexts</strong> and the <strong>Global Lock</strong>.</p>
<p>The idea is simple - while Redis in itself still remains single threaded, a module can run many threads - and any one of them can acquire the <strong>Global Lock</strong> when it needs to access Redis data, operate on it, and release it. </p>
<p>We still cannot really query Redis in parallel - only one thread can acquire the lock, including the Redis main thread - but we can make sure that a long running query will give other queries time to properly run by yielding this lock from time to time. Note that this limitation applies to our use case only - in other use cases such as training machine learning models, actual parallel processing the background is achievable and easy.</p>
<h2 id="4&quot;_&quot;making&quot;_&quot;search&quot;_&quot;concurrent">4. Making Search Concurrent<a class="headerlink" href="#4&quot;_&quot;making&quot;_&quot;search&quot;_&quot;concurrent" title="Permanent link">&para;</a></h2>
<p>Up until now, the flow of a search query was simple - the query would arrive at a <strong>Command Handler</strong> callback in the Redis Module, and it would be the only thing running inside Redis right now. Then it would parse the query, execute it, taking as long as it takes - and return the result. </p>
<p>To allow concurrency, we adapted the following design:</p>
<ol>
<li>
<p>RediSearch has a thread pool for running concurrent search queries. </p>
</li>
<li>
<p>When a search request arrives, it gets to the handler, gets parsed on the main thread, and a request object is passed to the thread pool via a queue.</p>
</li>
<li>
<p>The thread pool runs a query processing function in its own thread.</p>
</li>
<li>
<p>The function locks the Redis Global lock, and starts executing the query.</p>
</li>
<li>
<p>Since the search execution is basically an iterator running in a cycle, we simply sample the elapsed time every several iterations (sampling on each iteration would slow things down as it has a cost of its own).</p>
</li>
<li>
<p>If enough time has elapsed, the query processor releases the Global Lock, and immediately tries to acquire it again. When the lock is released, the kernel will schedule another thread to run - be it Redis' main thread, or another query thread.</p>
</li>
<li>
<p>When the lock is acquired again - we reopen all Redis resources we were holding before releasing the lock (keys might have been deleted while the thread has been "sleeping"), and continue work from the previous state. </p>
</li>
</ol>
<p>Thus the operating system's scheduler makes sure all query threads get CPU time to run. While one is running the rest wait idly, but since execution is yielded about 5,000 times a second, it creates the effect of concurrency. Fast queries will finish in one go without yielding execution, slow ones will take many iteration to finish, but will allow other queries to run concurrently. </p>
<blockquote>
<h3 id="figure&quot;_&quot;1&quot;_&quot;serial&quot;_&quot;vs&quot;_&quot;concurrent&quot;_&quot;search">Figure 1: Serial vs. Concurrent Search<a class="headerlink" href="#figure&quot;_&quot;1&quot;_&quot;serial&quot;_&quot;vs&quot;_&quot;concurrent&quot;_&quot;search" title="Permanent link">&para;</a></h3>
<p><img alt="Figure 1: Serial vs. Concurrent Search" src="../concurrency.png" title="Concurrency" /></p>
<p><strong>On the left-hand side, all queries are handled one after the other. On the right side, each query is given it time-slice to run. Notice that while the total time for all queries remain the same, queries 3 and 4 finish much faster.</strong></p>
</blockquote>
<p>The same approach is applied to indexing. If a document is big and tokenizing and indexing it will block Redis for a long time - we break that into many smaller iterations and allow Redis to do other things instead of blocking for a very long time. In fact, in the case of indexing there is enough work to be done in parallel using multiple cores - namely tokenizing and normalizing the document. This is especially effective for very big documents.</p>
<p>As a side note - this could have been implemented with a single thread switching between all the query execution loops, but the code refactoring required for that was much larger, and the effect with reasonable load would have remained similar, so we opted to keep this for a future release.</p>
<h2 id="5&quot;_&quot;the&quot;_&quot;effect&quot;_&quot;of&quot;_&quot;concurrency">5. The Effect of Concurrency<a class="headerlink" href="#5&quot;_&quot;the&quot;_&quot;effect&quot;_&quot;of&quot;_&quot;concurrency" title="Permanent link">&para;</a></h2>
<p>While this is not magic, and if all your queries are slow they will remain slow, and no real parallel processing is done here - this is revolutionary in Redis terms. Think about the old problem of running <code>KEYS *</code> in a busy Redis instance. In single threaded operation, this will cause the instance to hang for seconds if not minutes. No it is possible to implement a concurrent version of KEYS in a module, that will hardly affect performance. In fact, Salvatore has already implemented one!</p>
<p>There is, however, a negative effect as well: we sacrifice atomicity of reads and writes for concurrency to a degree. Consider the following situation: One thread is processing a query that should retrieve document A, then yields the execution context; At the same time, another thread deletes or changes document A. The result - the query run by the first thread will not be able to retrieve the document, as it has already been changed or deleted while the thread was "asleep". </p>
<p>This is of course only relevant to high update/delete loads, and relatively slow and complex queries. In our view, for most use cases this is a sacrifice worth making, and usually query processing is fast enough that the probability of this happening is very low. However, this can be overcome easily: if strong atomicity of the operations is important, it is possible to have RediSearch operate in "safe mode", making all searches and updates atomic, thus making sure that each query refers to the sate of the index at the moment of its invocation. </p>
<p>To enable safe mode and disable query concurrency, you can configure RediSearch at load time: <code>redis-server --loadmodule redisearch.so SAFEMODE</code> in command line, or by adding <code>loadmodule redisearch.so SAFEMODE</code> to your redis.conf - depending on how you load the module.</p>
<h2 id="6&quot;_&quot;some&quot;_&quot;numbers">6. Some Numbers!<a class="headerlink" href="#6&quot;_&quot;some&quot;_&quot;numbers" title="Permanent link">&para;</a></h2>
<p>I've benchmarked both versions of the module - simple single threaded, and concurrent multi threaded, over the same set up.</p>
<div class="admonition note">
<p class="admonition-title">Benchmark Setup</p>
<ul>
<li>The data-set consists of about 1,000,000 Reddit comments.</li>
<li>Two clients using Redis-benchmark were running  - first separately, then in parallel:</li>
<li>One client doing a very intensive query - "i" which has 200,000 results with 5 concurrent connections.</li>
<li>One client is doing a very light query - "Obama", which has about 500 results - with 10 concurrent connections (we assume in a normal situation there will be more lightweight queries than heavy queries).</li>
<li>Both clients and the server running on my personal laptop - MacBook Pro with an Intel Quad Core i7 @ 2.2Ghz.</li>
</ul>
</div>
<h3 id="the&quot;_&quot;results">The Results:<a class="headerlink" href="#the&quot;_&quot;results" title="Permanent link">&para;</a></h3>
<p><img alt="Throughput" src="../img/throughput.png" title="Throughput Benchmark" />
<img alt="Latency" src="../img/latency.png" title="Latency Benchmark" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While we can see that light queries are significantly slower when running in concurrent mode without contention, they are still very fast. But in contention, we see that lightweight queries run X40 faster in concurrent mode, since they are not blocked by the slow queries, as in single thread mode. In single thread mode we are only as fast as the slowest queries. </p>
</div>
<h2 id="7&quot;_&quot;parting&quot;_&quot;words">7. Parting Words<a class="headerlink" href="#7&quot;_&quot;parting&quot;_&quot;words" title="Permanent link">&para;</a></h2>
<p>This little Global Lock feature and Thread Safe Contexts, is perhaps the most powerful thing that the Modules API offers. We touched only the problem of concurrency here, but it also enables background tasks, real parallel processing of data that does not touch the Redis keyspace, and more.</p>
<p>For RediSearch, it makes the difference between being a nice engine for small-ish use cases, to being a real beast that can handle huge data-sets at high loads. Combined with the up-and-coming distributed version of RediSearch (that also leverages the threading API, but that's a story for another post), it will make RediSearch a very powerful search and indexing engine.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../design/gc/" title="Garbage Collection" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Garbage Collection
              </span>
            </div>
          </a>
        
        
          <a href="../Chinese/" title="Chinese Support" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Chinese Support
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b438e6c5.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:".."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-92003007-8","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>