
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="http://redisearch.io/Extensions/">
      
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.1.1">
    
    
      
        <title>Extension API - RediSearch Documentation</title>
      
    
    
      <script src="../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-4ebe3f1d68.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-f6789307ff.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="indigo" data-md-color-accent="">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href=".." title="RediSearch Documentation" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Extension API
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/RedisLabsModules/RediSearch" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    RediSearch Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/RedisLabsModules/RediSearch" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Quick_Start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Clients/" title="Client Libraries" class="md-nav__link">
      Client Libraries
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Commands/" title="Commands" class="md-nav__link">
      Commands
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Configuring/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Query_Syntax/" title="Query Syntax" class="md-nav__link">
      Query Syntax
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Stopwords/" title="Stop-Words" class="md-nav__link">
      Stop-Words
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Sorting/" title="Sortable Values" class="md-nav__link">
      Sortable Values
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Tags/" title="Tag Fields" class="md-nav__link">
      Tag Fields
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Highlight/" title="Highlighting Results" class="md-nav__link">
      Highlighting Results
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Scoring/" title="Scoring Documents" class="md-nav__link">
      Scoring Documents
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Extension API
      </label>
    
    <a href="./" title="Extension API" class="md-nav__link md-nav__link--active">
      Extension API
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#registering-and-loading-extensions" title="Registering and Loading Extensions" class="md-nav__link">
    Registering and Loading Extensions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-an-extension" title="Initializing an Extension" class="md-nav__link">
    Initializing an Extension
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-init-function" title="Example Init Function" class="md-nav__link">
    Example Init Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calling-your-custom-functions" title="Calling your custom functions" class="md-nav__link">
    Calling your custom functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-query-expander-api" title="The Query Expander API" class="md-nav__link">
    The Query Expander API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rsqueryexpanderctx" title="RSQueryExpanderCtx" class="md-nav__link">
    RSQueryExpanderCtx
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rstoken" title="RSToken" class="md-nav__link">
    RSToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-scoring-function-api" title="The Scoring Function API" class="md-nav__link">
    The Scoring Function API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rsscoringfunctionctx" title="RSScoringFunctionCtx" class="md-nav__link">
    RSScoringFunctionCtx
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsindexresult" title="RSIndexResult" class="md-nav__link">
    RSIndexResult
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsdocumentmetadata" title="RSDocumentMetadata" class="md-nav__link">
    RSDocumentMetadata
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-query-expander" title="Example Query Expander" class="md-nav__link">
    Example Query Expander
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-scoring-function" title="Example Scoring Function" class="md-nav__link">
    Example Scoring Function
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Stemming/" title="Stemming Support" class="md-nav__link">
      Stemming Support
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../python_client/" title="Python API" class="md-nav__link">
      Python API
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../java_client/" title="Java API" class="md-nav__link">
      Java API
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../payloads/" title="Document Payloads" class="md-nav__link">
      Document Payloads
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      Design Documents
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        Design Documents
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../design/gc/" title="Garbage Collection" class="md-nav__link">
      Garbage Collection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18" type="checkbox" id="nav-18">
    
    <label class="md-nav__link" for="nav-18">
      Articles
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-18">
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Threading/" title="Multi-Threading in RediSearch" class="md-nav__link">
      Multi-Threading in RediSearch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#registering-and-loading-extensions" title="Registering and Loading Extensions" class="md-nav__link">
    Registering and Loading Extensions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-an-extension" title="Initializing an Extension" class="md-nav__link">
    Initializing an Extension
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-init-function" title="Example Init Function" class="md-nav__link">
    Example Init Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calling-your-custom-functions" title="Calling your custom functions" class="md-nav__link">
    Calling your custom functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-query-expander-api" title="The Query Expander API" class="md-nav__link">
    The Query Expander API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rsqueryexpanderctx" title="RSQueryExpanderCtx" class="md-nav__link">
    RSQueryExpanderCtx
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rstoken" title="RSToken" class="md-nav__link">
    RSToken
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-scoring-function-api" title="The Scoring Function API" class="md-nav__link">
    The Scoring Function API
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rsscoringfunctionctx" title="RSScoringFunctionCtx" class="md-nav__link">
    RSScoringFunctionCtx
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsindexresult" title="RSIndexResult" class="md-nav__link">
    RSIndexResult
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rsdocumentmetadata" title="RSDocumentMetadata" class="md-nav__link">
    RSDocumentMetadata
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-query-expander" title="Example Query Expander" class="md-nav__link">
    Example Query Expander
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-scoring-function" title="Example Scoring Function" class="md-nav__link">
    Example Scoring Function
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/RedisLabsModules/RediSearch/edit/master/docs/Extensions.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="extending-redisearch">Extending RediSearch<a class="headerlink" href="#extending-redisearch" title="Permanent link">&para;</a></h1>
<p>RediSearch supports an extension mechanism, much like Redis supports modules. The API is very minimal at the moment, and it does not yet support dynamic loading of extensions in run-time. Instead, extensions must be written in C (or a language that has an interface with C) and compiled into dynamic libraries that will be loaded at run-time.</p>
<p>There are two kinds of extension APIs at the moment: </p>
<ol>
<li><strong>Query Expanders</strong>, whose role is to expand query tokens (i.e. stemmers).</li>
<li><strong>Scoring Funtions</strong>, whose role is to rank search results in query time.</li>
</ol>
<h2 id="registering-and-loading-extensions">Registering and Loading Extensions<a class="headerlink" href="#registering-and-loading-extensions" title="Permanent link">&para;</a></h2>
<p>Extensions should be compiled into .so files, and loaded into RediSearch on initialization of the module. </p>
<ul>
<li>
<p>Compiling </p>
<p>Extensions should be compiled and linked as dynamic libraries. An example Makefile for an extension <a href="https://github.com/RedisLabsModules/RediSearch/blob/master/src/tests/ext-example/Makefile">can be found here</a>. </p>
<p>That folder also contains an example extension that is used for testing, and can be taken as a skeleton for implementing your own extension.</p>
</li>
<li>
<p>Loading </p>
<p>Loading an extension is done by apending <code>EXTLOAD {path/to/ext.so}</code> after the <code>loadmodule</code> configuration directive when loading RediSearch. For example:</p>
<p><code>sh
$ redis-server --loadmodule ./redisearch.so EXTLOAD ./ext/my_extension.so</code></p>
<p>This causes RediSearch to automatically load the extension and register its expanders and scorers. </p>
</li>
</ul>
<h2 id="initializing-an-extension">Initializing an Extension<a class="headerlink" href="#initializing-an-extension" title="Permanent link">&para;</a></h2>
<p>The entry point of an extension is a function with the signature:</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">RS_ExtensionInit</span><span class="p">(</span><span class="n">RSExtensionCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
</pre></div>


<p>When loading the extension, RediSearch looks for this function and calls it. This function is responsible for registering and initializing the expanders and scorers. </p>
<p>It should return REDISEARCH_ERR on error or REDISEARCH_OK on success.</p>
<h3 id="example-init-function">Example Init Function<a class="headerlink" href="#example-init-function" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;redisearch.h&gt; //must be in the include path</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">RS_ExtensionInit</span><span class="p">(</span><span class="n">RSExtensionCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>

  <span class="cm">/* Register  a scoring function with an alias my_scorer and no special private data and free function */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">RegisterScoringFunction</span><span class="p">(</span><span class="s">&quot;my_scorer&quot;</span><span class="p">,</span> <span class="n">MyCustomScorer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">REDISEARCH_ERR</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">REDISEARCH_ERR</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* Register a query expander  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">RegisterQueryExpander</span><span class="p">(</span><span class="s">&quot;my_expander&quot;</span><span class="p">,</span> <span class="n">MyExpander</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span>
      <span class="n">REDISEARCH_ERR</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">REDISEARCH_ERR</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">REDISEARCH_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h2 id="calling-your-custom-functions">Calling your custom functions<a class="headerlink" href="#calling-your-custom-functions" title="Permanent link">&para;</a></h2>
<p>When performing a query, you can tell RediSearch to use your scorers or expanders by specifing the SCORER or EXPANDER arguments, with the given alias.
e.g.:</p>
<div class="codehilite"><pre><span></span>FT.SEARCH my_index &quot;foo bar&quot; EXPANDER my_expander SCORER my_scorer
</pre></div>


<p><strong>NOTE</strong>: Expander and scorer aliases are <strong>case sensitive</strong>.</p>
<h2 id="the-query-expander-api">The Query Expander API<a class="headerlink" href="#the-query-expander-api" title="Permanent link">&para;</a></h2>
<p>At the moment, we only support basic query expansion, one token at a time. An expander can decide to expand any given token with as many tokens it wishes, that will be Union-merged in query time.</p>
<p>The API for an expander is the following:</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;redisearch.h&gt; //must be in the include path</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">MyQueryExpander</span><span class="p">(</span><span class="n">RSQueryExpanderCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RSToken</span> <span class="o">*</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<h3 id="rsqueryexpanderctx">RSQueryExpanderCtx<a class="headerlink" href="#rsqueryexpanderctx" title="Permanent link">&para;</a></h3>
<p>RSQueryExpanderCtx is a context that contains private data of the extension, and a callback method to expand the query. It is defined as:</p>
<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">RSQueryExpanderCtx</span> <span class="p">{</span>

  <span class="cm">/* Opaque query object used internally by the engine, and should not be accessed */</span>
  <span class="k">struct</span> <span class="n">RSQuery</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>

  <span class="cm">/* Opaque query node object used internally by the engine, and should not be accessed */</span>
  <span class="k">struct</span> <span class="n">RSQueryNode</span> <span class="o">**</span><span class="n">currentNode</span><span class="p">;</span>

  <span class="cm">/* Private data of the extension, set on extension initialization */</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">;</span>

  <span class="cm">/* The language of the query, defaults to &quot;english&quot; */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">language</span><span class="p">;</span>

  <span class="cm">/* ExpandToken allows the user to add an expansion of the token in the query, that will be</span>
<span class="cm">   * union-merged with the given token in query time. str is the expanded string, len is its length,</span>
<span class="cm">   * and flags is a 32 bit flag mask that can be used by the extension to set private information on</span>
<span class="cm">   * the token */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">ExpandToken</span><span class="p">)(</span><span class="k">struct</span> <span class="n">RSQueryExpanderCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
                      <span class="n">RSTokenFlags</span> <span class="n">flags</span><span class="p">);</span>

  <span class="cm">/* SetPayload allows the query expander to set GLOBAL payload on the query (not unique per token)</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">SetPayload</span><span class="p">)(</span><span class="k">struct</span> <span class="n">RSQueryExpanderCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RSPayload</span> <span class="n">payload</span><span class="p">);</span>

<span class="p">}</span> <span class="n">RSQueryExpanderCtx</span><span class="p">;</span>
</pre></div>


<h3 id="rstoken">RSToken<a class="headerlink" href="#rstoken" title="Permanent link">&para;</a></h3>
<p>RSToken represents a single query token to be expanded, and is defined as:</p>
<div class="codehilite"><pre><span></span><span class="cm">/* A token in the query. The expanders receive query tokens and can expand the query with more query</span>
<span class="cm"> * tokens */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="cm">/* The token string - which may or may not be NULL terminated */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
  <span class="cm">/* The token length */</span>
  <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

  <span class="cm">/* 1 if the token is the result of query expansion */</span>
  <span class="kt">uint8_t</span> <span class="nl">expanded</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>

  <span class="cm">/* Extension specific token flags that can be examined later by the scoring function */</span>
  <span class="n">RSTokenFlags</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">RSToken</span><span class="p">;</span>
</pre></div>


<h2 id="the-scoring-function-api">The Scoring Function API<a class="headerlink" href="#the-scoring-function-api" title="Permanent link">&para;</a></h2>
<p>A scoring function receives each document being evaluated by the query, for final ranking. 
It has access to all the query terms that brought up the document,and to metadata about the
document such as its a-priory score, length, etc.</p>
<p>Since the scoring function is evaluated per each document, potentially millions of times, and since
redis is single threaded - it is important that it works as fast as possible and be heavily optimized. </p>
<p>A scoring function is applied to each potential result (per document) and is implemented with the following signature:</p>
<div class="codehilite"><pre><span></span><span class="kt">double</span> <span class="nf">MyScoringFunction</span><span class="p">(</span><span class="n">RSScoringFunctionCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RSIndexResult</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
                                    <span class="n">RSDocumentMetadata</span> <span class="o">*</span><span class="n">dmd</span><span class="p">,</span> <span class="kt">double</span> <span class="n">minScore</span><span class="p">);</span>
</pre></div>


<p>RSScoringFunctionCtx is a context that implements some helper methods. </p>
<p>RSIndexResult is the result information - containing the document id, frequency, terms and offsets. </p>
<p>RSDocumentMetadata is an object holding global information about the document, such as its a-priory score. </p>
<p>minSocre is the minimal score that will yield a result that will be relevant to the search. It can be used to stop processing mid-way of before we even start.</p>
<p>The return value of the function is double representing the final score of the result. 
Returning 0 causes the result to be counted, but if there are results with a score greater than 0, they will appear above it. 
To completely filter out a result and not count it in the totals, the scorer should return the special value <code>RS_SCORE_FILTEROUT</code> (which is internally to negative infinity, or -1/0). </p>
<h3 id="rsscoringfunctionctx">RSScoringFunctionCtx<a class="headerlink" href="#rsscoringfunctionctx" title="Permanent link">&para;</a></h3>
<p>This is an object containing the following members:</p>
<ul>
<li><strong>void *privdata</strong>: a pointer to an object set by the extension on initialization time.</li>
<li><strong>RSPayload payload</strong>: A Payload object set either by the query expander or the client.</li>
<li><strong>int GetSlop(RSIndexResult *res)</strong>: A callback method that yields the total minimal distance between the query terms. This can be used to prefer results where the "slop" is smaller and the terms are nearer to each other.</li>
</ul>
<h3 id="rsindexresult">RSIndexResult<a class="headerlink" href="#rsindexresult" title="Permanent link">&para;</a></h3>
<p>This is an object holding the information about the current result in the index, which is an aggregate of all the terms that resulted in the current document being considered a valid result.</p>
<p>See redisearch.h for details</p>
<h3 id="rsdocumentmetadata">RSDocumentMetadata<a class="headerlink" href="#rsdocumentmetadata" title="Permanent link">&para;</a></h3>
<p>This is an object describing global information, unrelated to the current query, about the document being evaluated by the scoring function. </p>
<h2 id="example-query-expander">Example Query Expander<a class="headerlink" href="#example-query-expander" title="Permanent link">&para;</a></h2>
<p>This example query expander expands each token with the the term foo:</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;redisearch.h&gt; //must be in the include path</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">DummyExpander</span><span class="p">(</span><span class="n">RSQueryExpanderCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RSToken</span> <span class="o">*</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ExpandToken</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">strdup</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">),</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">),</span> <span class="mh">0x1337</span><span class="p">);</span>  
<span class="p">}</span>
</pre></div>


<h2 id="example-scoring-function">Example Scoring Function<a class="headerlink" href="#example-scoring-function" title="Permanent link">&para;</a></h2>
<p>This is an actual scoring function, calculating TF-IDF for the document, multiplying that by the document score, and dividing that by the slop:</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;redisearch.h&gt; //must be in the include path</span><span class="cp"></span>

<span class="kt">double</span> <span class="nf">TFIDFScorer</span><span class="p">(</span><span class="n">RSScoringFunctionCtx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RSIndexResult</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="n">RSDocumentMetadata</span> <span class="o">*</span><span class="n">dmd</span><span class="p">,</span>
                   <span class="kt">double</span> <span class="n">minScore</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// no need to evaluate documents with score 0 </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dmd</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// calculate sum(tf-idf) for each term in the result</span>
  <span class="kt">double</span> <span class="n">tfidf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">numRecords</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// take the term frequency and multiply by the term IDF, add that to the total</span>
    <span class="n">tfidf</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">term</span> <span class="o">?</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">records</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">term</span><span class="o">-&gt;</span><span class="nl">idf</span> <span class="p">:</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// normalize by the maximal frequency of any term in the document   </span>
  <span class="n">tfidf</span> <span class="o">/=</span>  <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">dmd</span><span class="o">-&gt;</span><span class="n">maxFreq</span><span class="p">;</span>

  <span class="c1">// multiply by the document score (between 0 and 1)</span>
  <span class="n">tfidf</span> <span class="o">*=</span> <span class="n">dmd</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">;</span>

  <span class="c1">// no need to factor the slop if tfidf is already below minimal score</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tfidf</span> <span class="o">&lt;</span> <span class="n">minScore</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// get the slop and divide the result by it, making sure we prefer results with closer terms</span>
  <span class="n">tfidf</span> <span class="o">/=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">GetSlop</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">tfidf</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Scoring/" title="Scoring Documents" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Scoring Documents
              </span>
            </div>
          </a>
        
        
          <a href="../Stemming/" title="Stemming Support" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Stemming Support
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-89573912-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>